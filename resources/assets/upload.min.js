;(function(){var ringChart=function(e,h){var b=document.getElementById(e);var f=100;var j=parseFloat(h/f).toFixed(2);if(j>1){return}b.height=b.height+0;var a=null;if(!b.getContext){return}var i=Math.PI*1.5;var d=(Math.PI*2)*j;a=b.getContext("2d");a.font="16px Arial";a.fillStyle="#ff801a";a.textBaseline="middle";var g=(Number(h/f)*100).toFixed(0)+"%";var c=a.measureText(g).width;a.fillText(g,45-c/2,45);a.save();a.beginPath();a.strokeStyle="#e7e7e7";a.lineWidth="4";a.arc(45,45,30,0,Math.PI*2,false);a.closePath();a.stroke();a.restore();if(h/f===0){return}a.save();a.beginPath();a.strokeStyle="#ff801a";a.lineWidth="4";a.arc(45,45,30,i,(h%f===0?i:(d+i)),false);a.stroke();a.restore();a.save();a.beginPath();a.strokeStyle="#ff801a";a.lineWidth="2";a.strokeRect(0,0,90,90);a.stroke();a.restore()};var accessid="",host="",cdn_url="",policyBase64="",signature="",key="",expire=0,filename_new="",file_ext="";function get_signature(b){var a=timestamp=Date.parse(new Date())/1000;if(expire<a+300){$.ajax({url:"/admin/alioss_param",type:"get",dataType:"json",async:false,success:function(c){accessid=c["accessid"];host=c["host"];cdn_url=c["cdn_url"];policyBase64=c["policy"];signature=c["signature"];expire=parseInt(c["expire"]);key=c["dir"];b&&b()},error:function(){alert("抱歉！获取签名错误！")}})}else{b&&b()}}function set_upload_param(a,b){get_signature(function(){new_multipart_params={"key":key+b,"policy":policyBase64,"OSSAccessKeyId":accessid,"success_action_status":"200","signature":signature,};a.setOption({"url":host,"multipart_params":new_multipart_params})})}function random_string(b){b=b||32;var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var a=c.length;var d="";for(i=0;i<b;i++){d+=c.charAt(Math.floor(Math.random()*a))}return d}function get_suffix(a){var c=a.lastIndexOf(".");var b="";if(c!==-1){b=a.substring(c)}return b.toLowerCase()};window.del_pic=function(e,d){e=$(e);var a="";if(d){a=e.attr("data-filename");var c=e.parents("div.upload_warp");e.parents("div.upload_item").remove();if(c.find(".upload_item").length===0){c.hide()}}else{var b=e.parent();a=b.find("img").attr("data-filename");b.find("img").remove();b.find(".upload_add_img").show();b.find("input.Js_upload_input").val("")}};window.init_upload=function(g,f,c){var b=$("#"+g);var e=f?$(b.attr("data-warp")):b.parents(".Js_upload_warp");var a=$('<div style="height:0px;width:0px;display:none"></div>').appendTo(e);var d=new plupload.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:g,container:a.get(0),url:"/admin/upload_file",flash_swf_url:"./plupload-2.1.2/Moxie.swf",silverlight_xap_url:"./plupload-2.1.2/Moxie.xap",multi_selection:f,multipart_params:{"_token":c},filters:{max_file_size:"10mb",mime_types:[{title:"Image files",extensions:"jpg,jpeg,gif,png"}]},init:{FilesAdded:function(h,i){plupload.each(i,function(j){if(f){e.css("opacity",1).append('<div class="upload_item" id="'+j.id+'"><canvas id="'+j.id+'_canvas" width="90px" height="90px"></canvas></div>').show();Sortable.create(e.get(0),{group:{pull:false,put:false},handle:"img",ghostClass:"upload_ghost",chosenClass:"upload_chose",})}else{b.hide();e.prepend('<canvas id="'+j.id+'_canvas" width="90px" height="90px" style="margin-top: 5px;"></canvas>')}ringChart(j.id+"_canvas",0)});d.start()},BeforeUpload:function(h,i){file_ext=get_suffix(i.name);filename_new=Date.parse(new Date())/1000+"_"+random_string(10)+file_ext;set_upload_param(h,filename_new)},UploadProgress:function(h,i){ringChart(i.id+"_canvas",i.percent)},FileUploaded:function(h,j,l){var k=key+filename_new;var i=cdn_url+"/"+k;if(f){$("#"+j.id).html('<span class="upload_del_btn" data-filename="'+k+'" onclick="'+"del_pic(this,true)"+'">删除</span><img src="'+i+'?x-oss-process=image/resize,m_fill,w_100,h_100"><input type="hidden" class="Js_upload_input" name="'+g.split("_")[0]+'[]" value="'+k+'">')}else{$("#"+j.id+"_canvas").remove();e.prepend('<img data-filename="'+k+'" src="'+i+'?x-oss-process=image/resize,m_fill,w_100,h_100">').find("input.Js_upload_input").val(k)}},Error:function(h,i){alert("抱歉！出错了："+i.message)}}});d.init()};window.init_upload_edit=function(d,c){var g=d.imgMenuId;var b=d.toolbarElemId;var e=d.textElemId;var a=$('<div style="height:0;width:0;display:none"></div>').appendTo("body");var f=new plupload.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:g,container:a.get(0),url:"/admin/upload_file",flash_swf_url:"./plupload-2.1.2/Moxie.swf",silverlight_xap_url:"./plupload-2.1.2/Moxie.xap",multi_selection:false,multipart_params:{"_token":c},filters:{max_file_size:"10mb",mime_types:[{title:"Image files",extensions:"jpg,jpeg,gif,png"}]},init:{FilesAdded:function(h,j){var i=j[0];d.cmd.do('insertHtml', '<canvas id="'+i.id+'_canvas" width="90px" height="90px" style="margin-top: 5px;"></canvas>');f.start()},BeforeUpload:function(h,i){file_ext=get_suffix(i.name);filename_new=Date.parse(new Date())/1000+"_"+random_string(10)+file_ext;set_upload_param(h,filename_new)},UploadProgress:function(h,i){ringChart(i.id+"_canvas",i.percent)},FileUploaded:function(h,j,l){var k=key+filename_new;var i=cdn_url+"/"+k;$("#"+j.id+"_canvas").remove();d.cmd.do('insertHtml', '<img src="' + i + '" style="max-width:100%;"/>');},Error:function(h,i){alert("抱歉！出错了："+i.message)}}});f.init()};})();